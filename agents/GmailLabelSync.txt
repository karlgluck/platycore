INSTALL "https://raw.githubusercontent.com/karlgluck/platycore/master/agents/GmailLabelSync.txt"

This agent syncs Gmail labels to a separate spreadsheet and allows
batch operations on labels.

WORKFLOW:
1. Run [Make Sheet] to create the data sheet
2. Run [Sync From Gmail] to populate it with current labels
3. Set operations in the 'operation' column
4. Run [Run Operations] to execute them

AVAILABLE OPERATIONS:
- DELETE: Removes the label from Gmail
- CREATE: Creates a new label (use "/" for nested labels, e.g., "Parent/Child")
- RENAME: Changes label name (specify new name in 'rename_new_value' column)

The [Make Sheet] button creates the data sheet where labels are stored.

The [Sync From Gmail] button reads all Gmail labels and writes them
to the data sheet, showing label name, unread count, and total thread count.

The [Run Operations] button processes all operations marked in the sheet.
Runs in WhatIf mode unless EN is checked, protecting against accidental changes.

==================================================================
Common Initialization

      TITLE  "Gmail Label Sync"
    RESERVE  7

--- EN ---

   SELECT  "C2"
     NAME  "EN"
 CHECKBOX  "FALSE"

   SELECT  "D2"
    VALUE  "EN"

--- ON ---

   SELECT  "C3"
     NAME  "ON"
 CHECKBOX  "TRUE"
        +  "READONLY"

   SELECT  "D3"
    VALUE  "ON"

--- GO ---

   SELECT  "C4"
     NAME  "GO"
 CHECKBOX  "FALSE"

   SELECT  "D4"
    VALUE  "GO"

--- WAKE ---

   SELECT  "H2:L2"
     NAME  "WAKE"
    STYLE  "READONLY_FIELD"
   EVALUE  "Lang.GetTimestampNowP() + 15000"
     LOAD  "WAKE", "OLD_AGENT"

   SELECT  "F2:G2"
    VALUE  "WAKE"

   SELECT  "F3:L3"
  FORMULA  "=(H2-(60*2+4)*1000)/1000/60/60/24+25568.6681"
   FORMAT  "DATETIME"

--- LOCK ---

   SELECT  "H5:L5"
     NAME  "LOCK"
    STYLE  "READONLY_FIELD"
   EVALUE  "Lang.GetTimestampNowP()"

   SELECT  "F5:G5"
    VALUE  "LOCK"

   SELECT  "F6:L6"
  FORMULA  "=(H5-(60*2+4)*1000)/1000/60/60/24+25568.6681"
   FORMAT  "DATETIME"


==================================================================
Agent-specific

--- LABELS_SHEET ---

   SELECT "N2:R2"
    VALUE "Labels Sheet:"
   HALIGN "right"

   SELECT "S2:AH2"
     NAME "LABELS_SHEET"
    STYLE "FIELD"
     LOAD "LABELS_SHEET", "OLD_AGENT"

--- Synced Count ---
   SELECT "C6:D6"
    VALUE 0
     NAME "SYNCED_COUNT"
    STYLE "READONLY_FIELD"
     LOAD "SYNCED_COUNT", "OLD_AGENT"
   HALIGN "center"

   SELECT "E6"
    VALUE "labels synced"

--- Deleted Count ---
   SELECT "C7:D7"
    VALUE 0
     NAME "DELETED_COUNT"
    STYLE "READONLY_FIELD"
     LOAD "DELETED_COUNT", "OLD_AGENT"
   HALIGN "center"

   SELECT "E7"
    VALUE "labels deleted"


==================================================================
Manual Actions

--- [Make Sheet] ---

   SELECT "AJ2:AN2"
    VALUE "[Make Sheet]"
    STYLE "BUTTON"
     CODE "---"
------------------------
var sheet = SpreadsheetApp.create("Gmail Labels", 1, 1).getSheets()[0];
var headers = GAS.MergeSheetHeaders(sheet, ['label_name', 'unread_count', 'total_threads', 'operation', 'rename_new_value']);
GAS.AddRowsToJournalingSheet(
   [['<Label Name>', 0, 0, '', '']],
   sheet);
agent.WriteValue('LABELS_SHEET', GAS.GetUrlFromSheet(sheet));
agent.Info('Created labels sheet: ' + GAS.GetUrlFromSheet(sheet));
------------------------

--- [Sync From Gmail] ---

   SELECT "N3:R3"
    VALUE "[Sync From Gmail]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
   <         EVAL "---"
   ------------------------
   var labelsSheetUrl = agent.ReadValue('LABELS_SHEET');
   if (!Lang.IsMeaningfulP(labelsSheetUrl)) {
      agent.Error('No labels sheet configured. Click [Make Sheet] first.');
   } else {
      var sheet = agent.OpenSheetUsingUrlFromValue('LABELS_SHEET');
      var labels = GmailApp.getUserLabels();

      agent.Info("=== Syncing Gmail Labels ===");
      agent.Info("Found " + labels.length + " labels");

      // Build array of label data
      var data = [];
      labels.forEach(function(label) {
         var name = label.getName();
         var unread = label.getUnreadCount();
         var totalThreads = label.getThreads().length;

         data.push({
            label_name: name,
            unread_count: unread,
            total_threads: totalThreads,
            operation: '',
            rename_new_value: ''
         });

         agent.Info(name + " | Unread: " + unread + " | Threads: " + totalThreads);
      });

      // Write to sheet using GAS utilities
      var headers = ['label_name', 'unread_count', 'total_threads', 'operation', 'rename_new_value'];
      GAS.WriteSheetUsingObjects(sheet, data, headers);

      agent.WriteValue('SYNCED_COUNT', data.length);
      agent.Info("=== Sync Complete ===");
      agent.Info("Synced " + data.length + " labels to spreadsheet");
   }
   ------------------------
------------------------

    TURN_OFF

--- [Run Operations] ---

   SELECT "W4:AE4"
    VALUE "[Run Operations]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
   <      ENTER_WHAT_IF_MODE_UNLESS "EN"
          EVAL "---"
   ------------------------
   var labelsSheetUrl = agent.ReadValue('LABELS_SHEET');
   if (!Lang.IsMeaningfulP(labelsSheetUrl)) {
      agent.Error('No labels sheet configured. Click [Make Sheet] first.');
   } else {
      var sheet = agent.OpenSheetUsingUrlFromValue('LABELS_SHEET');
      var objects = GAS.MakeObjectsUsingSheetP(sheet);

      agent.Info("=== Processing Label Operations ===");

      var deleteCount = 0;
      var createCount = 0;
      var renameCount = 0;
      var remainingObjects = [];

      objects.forEach(function(obj) {
         var labelName = Lang.MakeStringUsingAnyP(obj.label_name).trim();
         var operation = Lang.MakeStringUsingAnyP(obj.operation).toUpperCase().trim();
         var renameNewValue = Lang.MakeStringUsingAnyP(obj.rename_new_value).trim();

         if (operation === "DELETE" && Lang.IsMeaningfulP(labelName)) {
            if (agent.WhatIf) {
               agent.Info("[WhatIf]: Would delete label: " + labelName);
               deleteCount++;
               remainingObjects.push(obj);
            } else {
               try {
                  var label = GmailApp.getUserLabelByName(labelName);
                  if (label) {
                     label.deleteLabel();
                     agent.Info("Deleted label: " + labelName);
                     deleteCount++;
                     // Don't add to remainingObjects - it's deleted
                  } else {
                     agent.Warn("Label not found in Gmail: " + labelName);
                     remainingObjects.push(obj);
                  }
               } catch (e) {
                  agent.Warn("Failed to delete label '" + labelName + "': " + e.message);
                  remainingObjects.push(obj);
               }
            }
         } else if (operation === "CREATE" && Lang.IsMeaningfulP(labelName)) {
            if (agent.WhatIf) {
               agent.Info("[WhatIf]: Would create label: " + labelName);
               createCount++;
               remainingObjects.push(obj);
            } else {
               try {
                  var existingLabel = GmailApp.getUserLabelByName(labelName);
                  if (existingLabel) {
                     agent.Warn("Label already exists: " + labelName);
                     remainingObjects.push(obj);
                  } else {
                     GmailApp.createLabel(labelName);
                     agent.Info("Created label: " + labelName);
                     createCount++;
                     obj.operation = '';  // Clear operation after success
                     remainingObjects.push(obj);
                  }
               } catch (e) {
                  agent.Warn("Failed to create label '" + labelName + "': " + e.message);
                  remainingObjects.push(obj);
               }
            }
         } else if (operation === "RENAME" && Lang.IsMeaningfulP(labelName) && Lang.IsMeaningfulP(renameNewValue)) {
            if (agent.WhatIf) {
               agent.Info("[WhatIf]: Would rename label '" + labelName + "' to '" + renameNewValue + "'");
               renameCount++;
               remainingObjects.push(obj);
            } else {
               try {
                  var oldLabel = GmailApp.getUserLabelByName(labelName);
                  if (!oldLabel) {
                     agent.Warn("Label not found in Gmail: " + labelName);
                     remainingObjects.push(obj);
                  } else {
                     // Check if new label already exists
                     var existingNewLabel = GmailApp.getUserLabelByName(renameNewValue);
                     if (existingNewLabel) {
                        agent.Warn("Target label already exists: " + renameNewValue);
                        remainingObjects.push(obj);
                     } else {
                        // Create new label
                        var newLabel = GmailApp.createLabel(renameNewValue);

                        // Move all threads from old label to new label
                        var threads = oldLabel.getThreads();
                        if (threads.length > 0) {
                           newLabel.addToThreads(threads);
                           oldLabel.removeFromThreads(threads);
                        }

                        // Delete old label
                        oldLabel.deleteLabel();

                        agent.Info("Renamed label '" + labelName + "' to '" + renameNewValue + "' (" + threads.length + " threads)");
                        renameCount++;

                        // Update object with new name and clear operation
                        obj.label_name = renameNewValue;
                        obj.operation = '';
                        obj.rename_new_value = '';
                        remainingObjects.push(obj);
                     }
                  }
               } catch (e) {
                  agent.Warn("Failed to rename label '" + labelName + "': " + e.message);
                  remainingObjects.push(obj);
               }
            }
         } else {
            remainingObjects.push(obj);
         }
      });

      // Write back the remaining objects (with deleted ones removed)
      if (!agent.WhatIf) {
         var headers = ['label_name', 'unread_count', 'total_threads', 'operation', 'rename_new_value'];
         GAS.WriteSheetUsingObjects(sheet, remainingObjects, headers);
      }

      agent.Info("=== Operations Complete ===");
      if (agent.WhatIf) {
         agent.Info("[WhatIf]: Would have deleted " + deleteCount + " label(s)");
         agent.Info("[WhatIf]: Would have created " + createCount + " label(s)");
         agent.Info("[WhatIf]: Would have renamed " + renameCount + " label(s)");
         agent.Info("[WhatIf]: Set EN=TRUE to actually execute operations");
      } else {
         agent.Info("Deleted: " + deleteCount + " | Created: " + createCount + " | Renamed: " + renameCount);
         if (deleteCount > 0) {
            var currentDeleted = Lang.MakeIntUsingAnyP(agent.ReadValue('DELETED_COUNT'));
            agent.WriteValue('DELETED_COUNT', currentDeleted + deleteCount);
         }
      }
   }
   ------------------------
------------------------

    TURN_OFF

--- [Reinstall] ---

   SELECT "AS6:AV6"
    VALUE "[Reinstall]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
      ALIAS "OLD_AGENT"
      EXPORT
      UNINSTALL
      NEW_AGENT "NEW_AGENT"
      SELECT "STACK"
      LOAD "REINSTALL_URL", "OLD_AGENT"
      INSTALL null
------------------------

   SELECT "AJ6:AR6"
     NAME "REINSTALL_URL"
    STYLE "FIELD"
     LOAD "$LAST_INSTALL_URL"
