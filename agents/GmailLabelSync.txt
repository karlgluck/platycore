INSTALL "https://raw.githubusercontent.com/karlgluck/platycore/master/agents/GmailLabelSync.txt"

This agent syncs Gmail labels to a spreadsheet table and
allows deletion of labels marked "DELETE" in the operation_to_perform column.

The [Sync From Gmail] button reads all Gmail labels and writes them
to the spreadsheet starting at row 8, showing label name, unread count,
and total thread count.

The [Delete Labels] button runs in WhatIf mode unless EN is checked,
protecting against accidental deletions.

==================================================================
Common Initialization

      TITLE  "Gmail Label Sync"
    RESERVE  7

--- EN ---

   SELECT  "C2"
     NAME  "EN"
 CHECKBOX  "FALSE"

   SELECT  "D2"
    VALUE  "EN"

--- ON ---

   SELECT  "C3"
     NAME  "ON"
 CHECKBOX  "TRUE"
        +  "READONLY"

   SELECT  "D3"
    VALUE  "ON"

--- GO ---

   SELECT  "C4"
     NAME  "GO"
 CHECKBOX  "FALSE"

   SELECT  "D4"
    VALUE  "GO"

--- WAKE ---

   SELECT  "H2:L2"
     NAME  "WAKE"
    STYLE  "READONLY_FIELD"
   EVALUE  "Lang.GetTimestampNowP() + 15000"
     LOAD  "WAKE", "OLD_AGENT"

   SELECT  "F2:G2"
    VALUE  "WAKE"

   SELECT  "F3:L3"
  FORMULA  "=(H2-(60*2+4)*1000)/1000/60/60/24+25568.6681"
   FORMAT  "DATETIME"

--- LOCK ---

   SELECT  "H5:L5"
     NAME  "LOCK"
    STYLE  "READONLY_FIELD"
   EVALUE  "Lang.GetTimestampNowP()"

   SELECT  "F5:G5"
    VALUE  "LOCK"

   SELECT  "F6:L6"
  FORMULA  "=(H5-(60*2+4)*1000)/1000/60/60/24+25568.6681"
   FORMAT  "DATETIME"


==================================================================
Agent-specific

--- Table Headers ---

   SELECT "N7"
    VALUE "Label Name"
       BG "#434343"
       FG "#FFFFFF"
   HALIGN "center"

   SELECT "O7"
    VALUE "Unread Count"
       BG "#434343"
       FG "#FFFFFF"
   HALIGN "center"

   SELECT "P7"
    VALUE "Total Threads"
       BG "#434343"
       FG "#FFFFFF"
   HALIGN "center"

   SELECT "Q7"
    VALUE "Operation"
       BG "#434343"
       FG "#FFFFFF"
   HALIGN "center"

--- Synced Count ---
   SELECT "C6:D6"
    VALUE 0
     NAME "SYNCED_COUNT"
    STYLE "READONLY_FIELD"
     LOAD "SYNCED_COUNT", "OLD_AGENT"
   HALIGN "center"

   SELECT "E6"
    VALUE "labels synced"

--- Deleted Count ---
   SELECT "C7:D7"
    VALUE 0
     NAME "DELETED_COUNT"
    STYLE "READONLY_FIELD"
     LOAD "DELETED_COUNT", "OLD_AGENT"
   HALIGN "center"

   SELECT "E7"
    VALUE "labels deleted"


==================================================================
Manual Actions

--- [Sync From Gmail] ---

   SELECT "N2:R2"
    VALUE "[Sync From Gmail]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
   <         EVAL "---"
   ------------------------
   var labels = GmailApp.getUserLabels();

   agent.Info("=== Syncing Gmail Labels ===");
   agent.Info("Found " + labels.length + " labels");

   // Clear existing data (rows 8 and below)
   var sheet = agent.Sheet;
   var lastRow = sheet.getLastRow();
   if (lastRow >= 8) {
      sheet.getRange(8, 14, lastRow - 7, 4).clearContent();
   }

   // Build data array
   var data = [];
   labels.forEach(function(label) {
      var name = label.getName();
      var unread = label.getUnreadCount();
      var totalThreads = label.getThreads().length;

      data.push([name, unread, totalThreads, ""]);

      agent.Info(name + " | Unread: " + unread + " | Threads: " + totalThreads);
   });

   // Write to sheet starting at row 8, column N (14)
   if (data.length > 0) {
      sheet.getRange(8, 14, data.length, 4).setValues(data);
      agent.WriteValue('SYNCED_COUNT', data.length);
   }

   agent.Info("=== Sync Complete ===");
   agent.Info("Synced " + data.length + " labels to spreadsheet");
   ------------------------
------------------------

    TURN_OFF

--- [Delete Labels] ---

   SELECT "N3:R3"
    VALUE "[Delete Labels]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
   <         EVAL "---"
   ------------------------
      ENTER_WHAT_IF_MODE_UNLESS "EN"
   ------------------------
   var sheet = agent.Sheet;
   var lastRow = sheet.getLastRow();

   if (lastRow < 8) {
      agent.Info("No data found. Please sync from Gmail first.");
      return;
   }

   // Read data from table starting at row 8
   var dataRange = sheet.getRange(8, 14, lastRow - 7, 4);
   var data = dataRange.getValues();

   agent.Info("=== Scanning for Labels to Delete ===");

   var deleteCount = 0;
   var rowsToDelete = [];

   // Scan for "DELETE" in operation column (index 3)
   for (var i = 0; i < data.length; i++) {
      var labelName = data[i][0];
      var operation = Lang.MakeStringUsingAnyP(data[i][3]).toUpperCase().trim();

      if (operation === "DELETE" && labelName) {
         if (agent.WhatIf) {
            agent.Info("[WhatIf]: Would delete label: " + labelName);
         } else {
            try {
               var label = GmailApp.getUserLabelByName(labelName);
               if (label) {
                  label.deleteLabel();
                  agent.Info("Deleted label: " + labelName);
                  rowsToDelete.push(i + 8); // Store row number for clearing
                  deleteCount++;
               } else {
                  agent.Warn("Label not found in Gmail: " + labelName);
               }
            } catch (e) {
               agent.Error("Failed to delete label '" + labelName + "': " + e.message);
            }
         }
         deleteCount++;
      }
   }

   // Clear the deleted rows from spreadsheet
   if (!agent.WhatIf && rowsToDelete.length > 0) {
      rowsToDelete.reverse().forEach(function(rowNum) {
         sheet.getRange(rowNum, 14, 1, 4).clearContent();
      });
   }

   agent.Info("=== Delete Operation Complete ===");
   if (agent.WhatIf) {
      agent.Info("[WhatIf]: Would have deleted " + deleteCount + " label(s)");
      agent.Info("[WhatIf]: Set EN=TRUE to actually delete labels");
   } else {
      agent.Info("Deleted " + deleteCount + " label(s)");
      if (deleteCount > 0) {
         var currentDeleted = Lang.MakeIntUsingAnyP(agent.ReadValue('DELETED_COUNT'));
         agent.WriteValue('DELETED_COUNT', currentDeleted + deleteCount);
      }
   }
   ------------------------
------------------------

    TURN_OFF

--- [Reinstall] ---

   SELECT "AS6:AV6"
    VALUE "[Reinstall]"
    STYLE "BUTTON"
     NOTE "---"
------------------------
      ALIAS "OLD_AGENT"
      EXPORT
      UNINSTALL
      NEW_AGENT "NEW_AGENT"
      SELECT "STACK"
      LOAD "REINSTALL_URL", "OLD_AGENT"
      INSTALL null
------------------------

   SELECT "AJ6:AR6"
     NAME "REINSTALL_URL"
    STYLE "FIELD"
     LOAD "$LAST_INSTALL_URL"
